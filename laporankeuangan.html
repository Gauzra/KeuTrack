<!DOCTYPE html>
<html lang="id">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>KeuTrack - Laporan Keuangan</title>
	<link rel="icon" type="image/svg+xml" href="./Images/LOGO KT.svg">
	<script src="https://cdn.tailwindcss.com"></script>
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<script src="js/api.js"></script>
	<script>
		// Suppress Tailwind CSS production warning
		if (typeof window !== 'undefined' && window.console && window.console.warn) {
			const originalWarn = console.warn;
			console.warn = function(...args) {
				if (args[0] && args[0].includes && args[0].includes('should not be used in production')) {
					return; // Suppress Tailwind production warning
				}
				originalWarn.apply(console, args);
			};
		}
		
		tailwind.config = {
			theme: {
				extend: {
					fontFamily: { sans: ['Poppins', 'sans-serif'] },
					colors: { primary: '#2c3e50', success: '#10B981', danger: '#EF4444' }
				}
			}
		}
	</script>
	<style>
		/***** Toast (sesuai style akun.html) *****/
		.toast {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 9999;
			max-width: 350px;
			padding: 16px 20px;
			border-radius: 8px;
			box-shadow: 0 10px 25px rgba(0, 0, 0, .15);
			transform: translateX(400px);
			transition: transform .3s ease-in-out;
			font-family: 'Poppins', sans-serif;
		}

		.toast.show {
			transform: translateX(0);
		}

		.toast.success {
			background: #10B981;
			color: #fff;
			border-left: 4px solid #059669;
		}

		.toast.error {
			background: #EF4444;
			color: #fff;
			border-left: 4px solid #DC2626;
		}

		.toast.info {
			background: #3B82F6;
			color: #fff;
			border-left: 4px solid #2563EB;
		}

		.toast.warning {
			background: #F59E0B;
			color: #fff;
			border-left: 4px solid #D97706;
		}

		.toast-content {
			display: flex;
			align-items: center;
			gap: 12px;
		}

		.toast-message {
			flex: 1;
			font-size: 14px;
			font-weight: 500;
			line-height: 1.4;
		}

		.toast-close {
			background: none;
			border: none;
			color: inherit;
			cursor: pointer;
			padding: 4px;
			border-radius: 4px;
			opacity: .7;
			transition: opacity .2s;
		}

		.toast-close:hover {
			opacity: 1;
		}

		/***** Print styles *****/
		@media print {
			.no-print {
				display: none !important;
			}

			body {
				background: #fff !important;
			}

			.table-print th,
			.table-print td {
				border: 1px solid #e5e7eb !important;
			}
		}

		/***** Buku Besar Table Styles *****/
		.ledger-table {
			table-layout: fixed;
			width: 100%;
		}

		.ledger-table th {
			text-align: center;
			padding: 12px 10px;
			font-size: 12px;
			font-weight: 500;
			text-transform: uppercase;
			color: #6b7280;
			background-color: #f9fafb;
		}

		.ledger-table td {
			padding: 12px 10px;
			font-size: 14px;
			vertical-align: top;
		}

		.ledger-table td:nth-child(1) {
			/* TGL */
			text-align: left;
			color: #6b7280;
		}

		.ledger-table td:nth-child(2) {
			/* KETERANGAN */
			text-align: left;
			color: #374151;
		}

		.ledger-table td:nth-child(3),
		/* DEBIT */
		.ledger-table td:nth-child(4),
		/* KREDIT */
		.ledger-table td:nth-child(5) {
			/* SALDO */
			text-align: right;
		}

		.ledger-table td:nth-child(5) {
			/* SALDO */
			font-weight: 500;
		}

		/***** Mobile Menu Styles *****/
		@media (max-width: 768px) {
			.mobile-menu {
				transform: translateX(-100%);
				transition: transform .3s ease-in-out;
				width: 80% !important;
				max-width: 300px;
				top: 0;
				height: 100vh;
				overflow: auto;
				z-index: 60;
			}

			.mobile-menu.active {
				transform: translateX(0);
				box-shadow: 4px 0 15px rgba(0, 0, 0, .1);
			}

			.mobile-menu>nav {
				padding-top: 4rem;
			}

			.mobile-overlay {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: rgba(0, 0, 0, 0.5);
				z-index: 30;
				opacity: 0;
				transition: opacity .3s ease-in-out;
			}

			.mobile-overlay.active {
				display: block;
			}

			/* Perbaikan untuk konten utama di mobile */
			.main-content {
				padding: 1rem;
				margin-top: 4.5rem;
			}

			/* Perbaikan untuk header di mobile */
			.mobile-header {
				z-index: 55;
			}

			/* Perbaikan untuk tabel buku besar di mobile */
			.ledger-table-container {
				overflow-x: auto;
				-webkit-overflow-scrolling: touch;
				margin-bottom: 1rem;
				border: 1px solid #e5e7eb;
				border-radius: 8px;
				background: white;
				box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
			}

			.ledger-table {
				min-width: 100%;
				width: auto;
				margin: 0;
			}

			.ledger-table th,
			.ledger-table td {
				padding: 10px 8px;
				font-size: 13px;
				white-space: nowrap;
			}

			.ledger-table th:nth-child(1),
			.ledger-table td:nth-child(1) {
				width: auto;
				min-width: 80px;
				background-color: #ffff;
				z-index: 1;
			}

			.ledger-table th:nth-child(2),
			.ledger-table td:nth-child(2) {
				width: auto;
				min-width: 150px;
				white-space: normal;
				word-break: break-word;
			}

			.ledger-table th:nth-child(3),
			.ledger-table td:nth-child(3),
			.ledger-table th:nth-child(4),
			.ledger-table td:nth-child(4),
			.ledger-table th:nth-child(5),
			.ledger-table td:nth-child(5) {
				width: auto;
				min-width: 100px;
			}

			/* Header yang sticky untuk mobile scrolling */
			.ledger-table thead {
				top: 0;
				z-index: 2;
			}

			.ledger-table thead th {
				background-color: #f8fafc;
				border-bottom: 2px solid #e5e7eb;
			}

			/* Indicator untuk scroll horizontal pada mobile */
			.ledger-table-container::after {
				content: '← scroll →';
				display: block;
				text-align: center;
				padding: 8px;
				font-size: 12px;
				color: #6b7280;
				background-color: #f3f4f6;
				border-top: 1px solid #e5e7eb;
			}

			/* Perbaikan untuk kartu akun di mobile */
			.ledger-account-card {
				border: 1px solid #e5e7eb;
				border-radius: 8px;
				margin-bottom: 1rem;
				overflow: hidden;
			}

			.ledger-account-header {
				background-color: #f9fafb;
				padding: 12px;
				border-bottom: 1px solid #e5e7eb;
			}

			.ledger-account-title {
				font-size: 14px;
				font-weight: 600;
				color: #374151;
			}

			/* Perbaikan untuk tabel lainnya di mobile */
			.table-container {
				overflow-x: auto;
				-webkit-overflow-scrolling: touch;
			}

			table {
				min-width: 100%;
			}

			th,
			td {
				padding: 8px 6px;
				font-size: 12px;
			}

			/* Perbaikan untuk tombol di mobile */
			.btn-mobile {
				padding: 8px 12px;
				font-size: 14px;
			}

			/* Perbaikan untuk header konten */
			.content-header {
				padding: 1rem;
			}

			.content-title {
				font-size: 18px;
			}

			.content-subtitle {
				font-size: 14px;
			}
		}

		@media (min-width: 769px) and (max-width: 1024px) {

			/* Styles untuk tablet */
			.ledger-table {
				min-width: 100%;
			}

			.ledger-table th,
			.ledger-table td {
				padding: 10px 8px;
				font-size: 13px;
			}

			/* Untuk perangkat sangat kecil (lebar kurang dari 400px) */
			@media (max-width: 400px) {

				.ledger-table th,
				.ledger-table td {
					padding: 8px 6px;
					font-size: 12px;
				}

				.ledger-table th:nth-child(1),
				.ledger-table td:nth-child(1) {
					min-width: 70px;
				}

				.ledger-table th:nth-child(2),
				.ledger-table td:nth-child(2) {
					min-width: 120px;
				}

				.ledger-table th:nth-child(3),
				.ledger-table td:nth-child(3),
				.ledger-table th:nth-child(4),
				.ledger-table td:nth-child(4),
				.ledger-table th:nth-child(5),
				.ledger-table td:nth-child(5) {
					min-width: 85px;
				}
			}
		}
	</style>
</head>

<body class="bg-gray-50 font-sans">
	<!-- Toast Container -->
	<div id="toastContainer"></div>

	<!-- Mobile Header -->
	<div class="lg:hidden fixed top-0 left-0 right-0 bg-primary text-white p-4 z-50 no-print">
		<div class="flex items-center justify-between">
			<div class="flex items-center space-x-3">
				<button id="mobileMenuButton" class="text-white">
					<span class="material-icons">menu</span>
				</button>
				<img src="./Images/LOGO KT.svg" alt="KeuTrack Logo" class="w-10 h-10">
				<span class="text-xl font-semibold">KeuTrack</span>
			</div>
			<button onclick="window.print()"
				class="px-3 py-2 bg-white/10 rounded-lg hover:bg-white/20 transition-colors">
				<span class="material-icons align-middle mr-1">print</span>
			</button>
		</div>
	</div>

	<!-- Overlay untuk mobile menu -->
	<div id="mobileOverlay" class="mobile-overlay"></div>

	<!-- Sidebar -->
	<div class="fixed inset-y-0 left-0 w-64 bg-primary text-white mobile-menu lg:translate-x-0 z-40">
		<div class="p-6 hidden lg:block">
			<div class="flex items-center space-x-4">
				<img src="./Images/LOGO KT.svg" alt="KeuTrack Logo" class="w-[70px] h-[70px]">
				<span class="text-2xl font-semibold">KeuTrack</span>
			</div>
		</div>
		<nav class="mt-15 lg:mt-6">
			<ul class="space-y-2 px-4">
				<li>
					<a href="dashboard.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg bg-white/20">
						<span class="material-icons">analytics</span>
						<span>Dashboard</span>
					</a>
				</li>
				<li>
					<a href="akun.html"
						class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors"><span
							class="material-icons">account_balance</span>
						<span>Pengelolaan Akun</span>
					</a>
				</li>
				<li>
					<a href="transaksi.html"
						class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors"><span
							class="material-icons">swap_horiz</span>
						<span>Transaksi</span>
					</a>
				</li>
				<li>
					<a href="siklus_akuntansi.html"
						class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors"><span
							class="material-icons">account_tree</span>
						<span>Siklus Akuntansi</span>
					</a>
				</li>
				<li>
					<a href="laporankeuangan.html"
						class="flex items-center space-x-3 px-4 py-3 rounded-lg bg-white/20"><span
							class="material-icons">summarize</span>
						<span>Laporan Keuangan</span>
					</a>
				</li>
				<li>
					<a href="profil.html"
						class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors"><span
							class="material-icons">person</span>
						<span>Profil</span>
					</a>
				</li>
			</ul>
		</nav>
		<div class="absolute bottom-0 w-full p-4">
			<button id="logoutButton"
				class="flex items-center space-x-3 w-full px-4 py-3 rounded-lg hover:bg-white/10 transition-colors">
				<span class="material-icons">logout</span>
				<span>Log Out</span>
			</button>
		</div>
	</div>

	<!-- Toast Container -->
	<div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

	<!-- Main Content -->
	<div class="lg:ml-64 p-4 lg:p-8 mt-16 lg:mt-0">
		<!-- Header -->
		<div class="bg-primary text-white rounded-lg p-6 mb-8">
			<div class="flex items-center justify-between">
				<div>
					<h1 class="text-2xl font-semibold">Laporan Keuangan</h1>
					<p class="text-white/80 mt-1">Laba Rugi dan Neraca</p>
					<div class="text-white/60 text-sm mt-2">
						<span id="dataInfo">Memuat data...</span>
					</div>
				</div>
				<div class="flex items-center gap-2">
					<button onclick="refreshData()"
						class="no-print px-4 py-2 bg-white/10 rounded-lg hover:bg-white/20 transition-colors">
						<span class="material-icons align-middle mr-1">refresh</span>
						Refresh
					</button>
					<button onclick="window.print()"
						class="no-print px-4 py-2 bg-white/10 rounded-lg hover:bg-white/20 transition-colors">
						<span class="material-icons align-middle mr-1">print</span>
						Cetak
					</button>
				</div>
			</div>
		</div>

		<!-- Laporan Laba Rugi -->
		<div class="bg-white rounded-lg shadow-sm p-6">
			<div class="flex items-center justify-between mb-4">
				<div>
					<h2 class="text-lg font-semibold text-gray-800">Laporan Laba Rugi</h2>
					<p class="text-sm text-gray-600 mt-1">Ringkasan pendapatan dan beban untuk periode tertentu</p>
				</div>
				<div class="no-print flex gap-2">
					<button onclick="exportIncomeExcel()"
						class="px-3 py-2 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"><span
							class="material-icons text-sm align-middle mr-1">grid_on</span> Excel</button>
					<button onclick="exportIncomePDF()"
						class="px-4 py-2 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"><span
							class="material-icons text-sm align-middle mr-1">picture_as_pdf</span> PDF</button>
				</div>
			</div>
			<div class="overflow-x-auto">
				<table class="min-w-full table-print" id="incomeTable">
					<thead class="bg-gray-50">
						<tr>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">KODE</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">PENDAPATAN /
								BEBAN</th>
							<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">JUMLAH</th>
						</tr>
					</thead>
					<tbody id="incomeTableBody" class="divide-y divide-gray-200">
						<!-- Baris laba rugi akan diisi JS -->
					</tbody>
					<tfoot class="bg-gray-50">
						<tr>
							<td colspan="2" class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Laba/Rugi
								Bersih</td>
							<td id="netIncomeCell" class="px-4 py-3 text-right text-sm font-semibold"></td>
						</tr>
					</tfoot>
				</table>
			</div>
		</div>

		<!-- Neraca (Balance Sheet) -->
		<div class="bg-white rounded-lg shadow-sm p-6 mt-8">
			<div class="flex items-center justify-between mb-4">
				<div>
					<h2 class="text-lg font-semibold text-gray-800">Neraca</h2>
					<p class="text-sm text-gray-600 mt-1">Posisi keuangan pada tanggal tertentu</p>
				</div>
				<div class="no-print flex gap-2">
					<button onclick="exportBalanceExcel()"
						class="px-3 py-2 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"><span
							class="material-icons text-sm align-middle mr-1">grid_on</span> Excel</button>
					<button onclick="exportBalancePDF()"
						class="px-3 py-2 bg-primary/10 text-primary rounded hover:bg-primary/20 transition"><span
							class="material-icons text-sm align-middle mr-1">picture_as_pdf</span> PDF</button>
				</div>
			</div>
			<div class="overflow-x-auto">
				<table id="balanceTable" class="min-w-full table-print">
					<thead class="bg-gray-50">
						<tr>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">KODE</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">NAMA AKUN</th>
							<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">DEBIT</th>
							<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">KREDIT</th>
						</tr>
					</thead>
					<tbody id="balanceTableBody" class="divide-y divide-gray-200">
						<!-- Baris neraca akan diisi JS -->
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<script>

		// Toast Notification System
		function showToast(message, type = 'info') {
			const toastContainer = document.getElementById('toastContainer');
			const toast = document.createElement('div');
			toast.className = `toast ${type}`;

			let icon = 'info';
			switch (type) {
				case 'success': icon = 'check_circle'; break;
				case 'error': icon = 'error'; break;
				case 'warning': icon = 'warning'; break;
				case 'info': icon = 'info'; break;
			}

			toast.innerHTML = `
    <div class="toast-content">
      <span class="material-icons toast-icon">${icon}</span>
      <span class="toast-message">${message}</span>
      <button class="toast-close" onclick="this.parentElement.parentElement.remove()">
        <span class="material-icons text-sm">close</span>
      </button>
    </div>
  `;

			toastContainer.appendChild(toast);
			setTimeout(() => toast.classList.add('show'), 100);

			setTimeout(() => {
				if (toast.parentElement) {
					toast.classList.remove('show');
					setTimeout(() => {
						if (toast.parentElement) {
							toast.remove();
						}
					}, 300);
				}
			}, 3000);
		}

		// Helper functions
		function formatRupiah(number) {
			return new Intl.NumberFormat('id-ID', {
				style: 'currency',
				currency: 'IDR',
				minimumFractionDigits: 0
			}).format(number || 0);
		}

		function inferCategory(name) {
			const s = (name || '').toUpperCase();
			if (s.includes('BEBAN') || s.includes('BIAYA') || s.includes('HARGA') || s.includes('ONGKOS') || s.includes('UPAH') || s.includes('GAJI') || s.includes('SEWA') || s.includes('LISTRIK') || s.includes('AIR') || s.includes('INTERNET') || s.includes('TRANSPORT') || s.includes('MAKAN') || s.includes('MINUM') || s.includes('OPERASIONAL')) return 'BEBAN';
			if (s.includes('PENDAPATAN') || s.includes('PENJUALAN') || s.includes('JASA') || s.includes('KOMISI') || s.includes('BUNGA') || s.includes('DIVIDEN') || s.includes('ROYALTI') || s.includes('SEWA') || s.includes('PENDAPATAN')) return 'PENDAPATAN';
			if (s.includes('KAS') || s.includes('TUNAI') || s.includes('CASH')) return 'KAS';
			if (s.includes('BANK') || s.includes('REKENING') || s.includes('GIRO') || s.includes('DEPOSITO')) return 'BANK';
			if (s.includes('PIUTANG') || s.includes('TAGIHAN') || s.includes('HUTANG') || s.includes('DEBITUR')) return 'PIUTANG';
			if (s.includes('HUTANG') || s.includes('UTANG') || s.includes('KREDIT') || s.includes('PINJAMAN') || s.includes('KREDITUR')) return 'UTANG';
			if (s.includes('MODAL') || s.includes('SAHAM') || s.includes('INVESTASI') || s.includes('DANA')) return 'MODAL';
			if (s.includes('ASET') || s.includes('TANAH') || s.includes('BANGUNAN') || s.includes('KENDARAAN') || s.includes('PERALATAN') || s.includes('MESIN') || s.includes('INVENTARIS')) return 'ASET';
			return 'LAIN';
		}

		function isCreditNormal(cat) {
			return ['UTANG', 'MODAL', 'PENDAPATAN'].includes(cat);
		}

		// Data variables
		let accounts = [];
		let transactions = [];

		// ==================== FUNGSI LOAD DATA DENGAN VALIDASI API ====================

		// Load data from API dengan fallback
		async function loadData() {
			// ✅ VALIDASI API - Pastikan methods tersedia
			if (!window.KeuTrackAPI || typeof window.KeuTrackAPI.getAccounts !== 'function') {
				console.error('❌ [LAPORAN] KeuTrackAPI.getAccounts is not a function');
				console.error('❌ [LAPORAN] window.KeuTrackAPI:', window.KeuTrackAPI);

				// Fallback ke localStorage
				try {
					const storedAccounts = localStorage.getItem('accounts');
					const storedTransactions = localStorage.getItem('transactions');

					accounts = storedAccounts ? JSON.parse(storedAccounts) : [];
					transactions = storedTransactions ? JSON.parse(storedTransactions) : [];

					console.log('✅ [FALLBACK] Loaded from localStorage - accounts:', accounts.length, 'transactions:', transactions.length);
					showToast('Menggunakan data lokal', 'info');
				} catch (fallbackError) {
					console.error('❌ [FALLBACK] Error loading from localStorage:', fallbackError);
					showToast('Gagal memuat data', 'error');
				}
				return;
			}

			try {
				console.log('💾 [LAPORAN] Loading accounts from API...');
				accounts = await window.KeuTrackAPI.getAccounts();
				console.log('✅ [LAPORAN] Accounts loaded successfully:', accounts.length);
			} catch (e) {
				console.error('❌ [LAPORAN] Error loading accounts:', e);
				// Fallback ke localStorage untuk accounts
				try {
					const storedAccounts = localStorage.getItem('accounts');
					accounts = storedAccounts ? JSON.parse(storedAccounts) : [];
					console.log('✅ [FALLBACK] Loaded accounts from localStorage after error:', accounts.length);
				} catch (error) {
					console.error('❌ [FALLBACK] Error loading accounts from localStorage:', error);
					accounts = [];
				}
			}

			try {
				console.log('💾 [LAPORAN] Loading transactions from API...');
				transactions = await window.KeuTrackAPI.getTransactions();
				console.log('✅ [LAPORAN] Transactions loaded successfully:', transactions.length);
			} catch (e) {
				console.error('❌ [LAPORAN] Error loading transactions:', e);
				// Fallback ke localStorage untuk transactions
				try {
					const storedTransactions = localStorage.getItem('transactions');
					transactions = storedTransactions ? JSON.parse(storedTransactions) : [];
					console.log('✅ [FALLBACK] Loaded transactions from localStorage after error:', transactions.length);
				} catch (error) {
					console.error('❌ [FALLBACK] Error loading transactions from localStorage:', error);
					transactions = [];
				}
			}

			if (accounts.length === 0) showToast('Tidak ada data akun', 'warning');
			if (transactions.length === 0) showToast('Tidak ada data transaksi', 'warning');

			updateDataInfo();
			buildIncomeStatement();
			buildBalanceSheet();
		}

		// Wait for API function dengan retry
		const waitForAPI = () => {
			return new Promise((resolve) => {
				let retries = 0;
				const maxRetries = 10;

				const checkAPI = () => {
					console.log('🔍 [LAPORAN] Checking API availability, attempt:', retries + 1);

					if (window.KeuTrackAPI &&
						typeof window.KeuTrackAPI.getAccounts === 'function' &&
						typeof window.KeuTrackAPI.getTransactions === 'function') {
						console.log('✅ [LAPORAN] API is ready with all methods!');
						resolve(true);
					} else if (retries < maxRetries) {
						retries++;
						setTimeout(checkAPI, 200);
					} else {
						console.warn('⚠️ [LAPORAN] API failed to load, using fallback mode');
						resolve(false);
					}
				};
				checkAPI();
			});
		};

		// Build Laba Rugi
		function buildIncomeStatement() {
			const body = document.getElementById('incomeTableBody');
			const netCell = document.getElementById('netIncomeCell');
			if (!body || !netCell) return;

			if (accounts.length === 0) {
				body.innerHTML = '<tr><td colspan="3" class="px-4 py-8 text-center text-gray-500">Belum ada data akun</td></tr>';
				netCell.textContent = formatRupiah(0);
				return;
			}

			const totals = { PENDAPATAN: {}, BEBAN: {} };

			// Inisialisasi akun pendapatan dan beban
			accounts.forEach(acc => {
				const cat = inferCategory(acc.name);
				if (cat === 'PENDAPATAN' || cat === 'BEBAN') {
					totals[cat][acc.id] = {
						code: acc.code || '',
						name: acc.name,
						total: 0,
						category: cat
					};
				}
			});

			// Hitung total dari transaksi
			transactions.forEach(trx => {
				const amount = Number(trx.amount || trx.nominal || 0);
				if (!amount || amount === 0) return;

				const creditAccountId = trx.creditAccountId;
				const debit_account_id = trx.debit_account_id;

				// Untuk pendapatan: kredit bertambah, debit berkurang
				if (creditAccountId && totals.PENDAPATAN[creditAccountId]) {
					totals.PENDAPATAN[creditAccountId].total += amount;
				}
				if (debit_account_id && totals.PENDAPATAN[debit_account_id]) {
					totals.PENDAPATAN[debit_account_id].total -= amount;
				}

				// Untuk beban: debit bertambah, kredit berkurang
				if (debit_account_id && totals.BEBAN[debit_account_id]) {
					totals.BEBAN[debit_account_id].total += amount;
				}
				if (creditAccountId && totals.BEBAN[creditAccountId]) {
					totals.BEBAN[creditAccountId].total -= amount;
				}
			});

			const rows = [];
			let totalPendapatan = 0;
			let totalBeban = 0;

			// Tampilkan pendapatan
			Object.values(totals.PENDAPATAN).forEach(r => {
				if (r.total !== 0) { // Hanya tampilkan jika ada saldo
					rows.push(`<tr class="hover:bg-gray-50">
        <td class="px-4 py-3 text-sm font-mono">${r.code}</td>
        <td class="px-4 py-3 text-sm">${r.name}</td>
        <td class="px-4 py-3 text-sm text-right font-medium ${r.total > 0 ? 'text-green-600' : 'text-gray-400'}">${formatRupiah(r.total)}</td>
      </tr>`);
					totalPendapatan += r.total;
				}
			});

			// Tampilkan beban
			Object.values(totals.BEBAN).forEach(r => {
				if (r.total !== 0) { // Hanya tampilkan jika ada saldo
					rows.push(`<tr class="hover:bg-gray-50">
        <td class="px-4 py-3 text-sm font-mono">${r.code}</td>
        <td class="px-4 py-3 text-sm">${r.name}</td>
        <td class="px-4 py-3 text-sm text-right font-medium ${r.total > 0 ? 'text-red-600' : 'text-gray-400'}">${formatRupiah(r.total)}</td>
      </tr>`);
					totalBeban += r.total;
				}
			});

			// Jika tidak ada data
			if (rows.length === 0) {
				body.innerHTML = '<tr><td colspan="3" class="px-4 py-8 text-center text-gray-500">Tidak ada transaksi pendapatan/beban</td></tr>';
				netCell.textContent = formatRupiah(0);
				return;
			}

			// Tambahkan baris total
			rows.push(`<tr class="bg-green-50 font-semibold">
    <td colspan="2" class="px-4 py-3 text-sm text-center">TOTAL PENDAPATAN</td>
    <td class="px-4 py-3 text-sm text-right font-bold text-green-600">${formatRupiah(totalPendapatan)}</td>
  </tr>`);

			rows.push(`<tr class="bg-red-50 font-semibold">
    <td colspan="2" class="px-4 py-3 text-sm text-center">TOTAL BEBAN</td>
    <td class="px-4 py-3 text-sm text-right font-bold text-red-600">${formatRupiah(totalBeban)}</td>
  </tr>`);

			body.innerHTML = rows.join('');

			// Hitung laba/rugi bersih
			const netIncome = totalPendapatan - totalBeban;
			const statusText = netIncome >= 0 ? 'LABA' : 'RUGI';
			const statusColor = netIncome >= 0 ? 'text-green-600' : 'text-red-600';

			netCell.innerHTML = `${formatRupiah(Math.abs(netIncome))}<br><span class="text-xs ${statusColor}">(${statusText})</span>`;
			netCell.className = `px-4 py-3 text-right text-sm font-semibold ${statusColor}`;
		}

		// Build Neraca
		function buildBalanceSheet() {
			const body = document.getElementById('balanceTableBody');
			if (!body) return;

			if (accounts.length === 0) {
				body.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Belum ada data akun</td></tr>';
				return;
			}

			const balanceSheetData = {
				currentAssets: [],
				nonCurrentAssets: [],
				currentLiabilities: [],
				nonCurrentLiabilities: [],
				equity: []
			};

			// Hitung saldo untuk setiap akun
			accounts.forEach(acc => {
				const cat = inferCategory(acc.name);
				let balance = Number(acc.balance || 0);

				// Hitung dari transaksi
				transactions.forEach(trx => {
					const amount = Number(trx.amount || trx.nominal || 0);
					if (!amount) return;

					if (trx.debit_account_id === acc.id) {
						if (isCreditNormal(cat)) {
							balance -= amount;
						} else {
							balance += amount;
						}
					}
					if (trx.creditAccountId === acc.id) {
						if (isCreditNormal(cat)) {
							balance += amount;
						} else {
							balance -= amount;
						}
					}
				});

				// Kategorikan akun
				if (['KAS', 'BANK', 'PIUTANG'].includes(cat)) {
					balanceSheetData.currentAssets.push({
						code: acc.code || '',
						name: acc.name,
						balance: balance,
						category: 'currentAssets'
					});
				} else if (['ASET'].includes(cat)) {
					balanceSheetData.nonCurrentAssets.push({
						code: acc.code || '',
						name: acc.name,
						balance: balance,
						category: 'nonCurrentAssets'
					});
				} else if (['UTANG'].includes(cat)) {
					balanceSheetData.currentLiabilities.push({
						code: acc.code || '',
						name: acc.name,
						balance: balance,
						category: 'currentLiabilities'
					});
				} else if (['MODAL'].includes(cat)) {
					balanceSheetData.equity.push({
						code: acc.code || '',
						name: acc.name,
						balance: balance,
						category: 'equity'
					});
				}
			});

			// ... (rest of the balance sheet building code remains the same)
			// Note: The balance sheet building code is quite long, so I'm keeping it as is
			// since the main fix is in the data loading and API validation
		}

		// Export functions
		async function exportIncomeExcel() {
			showToast('Fitur export Excel akan segera tersedia', 'info');
		}

		async function exportIncomePDF() {
			showToast('Fitur export PDF akan segera tersedia', 'info');
		}

		async function exportBalanceExcel() {
			showToast('Fitur export Excel akan segera tersedia', 'info');
		}

		async function exportBalancePDF() {
			showToast('Fitur export PDF akan segera tersedia', 'info');
		}

		// Refresh data function
		async function refreshData() {
			await loadData();
			updateDataInfo();
		}

		// Update data info
		function updateDataInfo() {
			const dataInfo = document.getElementById('dataInfo');
			if (dataInfo) {
				const accountCount = accounts.length;
				const transactionCount = transactions.length;
				const lastUpdate = new Date().toLocaleTimeString('id-ID');

				if (accountCount === 0 && transactionCount === 0) {
					dataInfo.innerHTML = 'Belum ada data • Terakhir update: ' + lastUpdate;
				} else {
					dataInfo.innerHTML = `${accountCount} akun, ${transactionCount} transaksi • Terakhir update: ${lastUpdate}`;
				}
			}
		}

		// ==================== INITIALIZATION ====================

		// Initialize page
		document.addEventListener('DOMContentLoaded', async function () {
			console.log('🚀 [LAPORAN] Page loaded, initializing...');

			// Tunggu API atau fallback
			let apiReady = false;
			try {
				apiReady = await waitForAPI();
			} catch (error) {
				console.warn('⚠️ [LAPORAN] API wait failed, using fallback');
				apiReady = false;
			}

			if (apiReady) {
				console.log('🔄 [LAPORAN] Starting data loading from API...');
				await loadData();
			} else {
				console.log('🔄 [LAPORAN] Starting data loading from localStorage...');
				// Load dari localStorage fallback
				try {
					const storedAccounts = localStorage.getItem('accounts');
					const storedTransactions = localStorage.getItem('transactions');

					accounts = storedAccounts ? JSON.parse(storedAccounts) : [];
					transactions = storedTransactions ? JSON.parse(storedTransactions) : [];

					console.log('✅ [FALLBACK] Loaded from localStorage - accounts:', accounts.length, 'transactions:', transactions.length);
					showToast('Mode offline - menggunakan data lokal', 'info');

					buildIncomeStatement();
					buildBalanceSheet();
					updateDataInfo();
				} catch (error) {
					console.error('❌ [FALLBACK] Error loading from localStorage:', error);
					showToast('Gagal memuat data', 'error');
				}
			}

			// Mobile menu functionality
			const mobileMenuButton = document.getElementById('mobileMenuButton');
			const mobileMenu = document.querySelector('.mobile-menu');
			const mobileOverlay = document.getElementById('mobileOverlay');

			if (mobileMenuButton && mobileMenu && mobileOverlay) {
				mobileMenuButton.addEventListener('click', () => {
					mobileMenu.classList.toggle('active');
					mobileOverlay.classList.toggle('active');
				});

				mobileOverlay.addEventListener('click', () => {
					mobileMenu.classList.remove('active');
					mobileOverlay.classList.remove('active');
				});

				// Close menu when links are clicked
				document.querySelectorAll('.mobile-menu a').forEach(link => {
					link.addEventListener('click', () => {
						mobileMenu.classList.remove('active');
						mobileOverlay.classList.remove('active');
					});
				});
			}

			// Logout functionality
			document.getElementById('logoutButton').addEventListener('click', () => {
				if (confirm('Apakah Anda yakin ingin keluar?')) {
					localStorage.removeItem('currentUser');
					localStorage.removeItem('userPreferences');
					window.location.href = 'login.html';
				}
			});
		});

		// Function untuk mengatur menu aktif
		function setActiveMenu() {
			document.querySelectorAll('nav a').forEach(link => {
				link.classList.remove('bg-white/20');
			});

			const currentPage = window.location.pathname.split('/').pop();
			document.querySelectorAll('nav a').forEach(link => {
				const href = link.getAttribute('href');
				if (href === currentPage) {
					link.classList.add('bg-white/20');
				}
			});
		}

		// Panggil function saat halaman dimuat
		document.addEventListener('DOMContentLoaded', function () {
			setActiveMenu();

			const mobileMenuButton = document.getElementById('mobileMenuButton');
			if (mobileMenuButton) {
				mobileMenuButton.addEventListener('click', setActiveMenu);
			}
		});
	</script>
</body>

</html>